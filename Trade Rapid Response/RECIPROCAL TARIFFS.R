pacman::p_load(censusapi,ggpubr,prismatic,maps,tigris,sf,maps,openxlsx,tidyverse,janitor,bea.R,readxl,RcppRoll,DSSAT,tidyr,eia,cli,remotes,magick,cowplot,knitr,ghostscript,png,httr,grid,usethis,pacman,rio,ggplot2,ggthemes,quantmod,dplyr,data.table,lubridate,forecast,gifski,av,tidyr,gganimate,zoo,RCurl,Cairo,datetime,stringr,pollster,tidyquant,hrbrthemes,plotly,fredr)

US_IMPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/imports/hs",
  vars = c("GEN_VAL_YR","CTY_CODE", "CTY_NAME"), 
  time = "2024-12",
  #I_COMMODITY = "????",
  #I_COMMODITY = "*",#ALL COuntries
  #CTY_CODE = "0201", #TOTAL
  #CTY_NAME = Countries[3],
  #CTY_NAME = Countries[4],
  #CTY_NAME = Countries[5],
)

US_EXPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/exports/hs",
  vars = c("ALL_VAL_YR","CTY_CODE", "CTY_NAME"), 
  time = "2024-12",
  #I_COMMODITY = "????",
  #I_COMMODITY = "*",#ALL COuntries
  #CTY_CODE = "0201", #TOTAL
  #CTY_NAME = Countries[3],
  #CTY_NAME = Countries[4],
  #CTY_NAME = Countries[5],
)

EU_27 <- c("AUSTRIA", "BELGIUM", "BULGARIA", "CROATIA", "CYPRUS", "CZECH REPUBLIC",
           "DENMARK", "ESTONIA", "FINLAND", "FRANCE", "GERMANY", "GREECE", "HUNGARY",
           "IRELAND", "ITALY", "LATVIA", "LITHUANIA", "LUXEMBOURG", "MALTA",
           "NETHERLANDS", "POLAND", "PORTUGAL", "ROMANIA", "SLOVAKIA", "SLOVENIA",
           "SPAIN", "SWEDEN")

RECIPROCAL_TARIFF_RATE <- merge(US_IMPORTS_BULK,US_EXPORTS_BULK, by = "CTY_NAME") %>%
  transmute(CTY_NAME, tariff = (as.numeric(GEN_VAL_YR)-as.numeric(ALL_VAL_YR))/as.numeric(GEN_VAL_YR)) %>%
  mutate(tariff = round(tariff,2)/2) %>%
  mutate(tariff = round(tariff,2)) %>%
  mutate(tariff = ifelse(tariff < 0.1, 0.1, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME == "AFHANISTAN", 0.1, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME %in% c("RUSSIA","CUBA","BELARUS","KOREA, NORTH"), NA, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME %in% c("MEXICO","CANADA"), NA, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME %in% EU_27, tariff[CTY_NAME == "EUROPEAN UNION"],tariff)) %>%
  mutate(CTY_NAME = str_to_title(CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "United Kingdom", "UK", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Congo (Kinshasa)", "Democratic Republic of the Congo", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Congo (Brazzaville)", "Republic of Congo", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Korea, South", "South Korea", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Korea, North", "North Korea", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Burma", "Myanmar", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Bosnia And Herzegovina", "Bosnia and Herzegovina", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Cote D'ivoire", "Ivory Coast", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Macedonia", "North Macedonia", CTY_NAME)) %>%
  mutate(CTY_NAME = ifelse(CTY_NAME == "Falkland Islands (Islas Malvinas)", "Falkland Islands", CTY_NAME)) 

  

TARIFF_MAP <- map_data("world") %>%
  mutate(region = ifelse(region == "Western Sahara", "Morocco", region)) %>%
  mutate(region = ifelse(region == "Palestine", "Israel", region)) %>% mutate("Palestine" = "Isreal") %>% #The US does not recognize Western Sahara or Palestine so they are treated as parts of Morocco and Israel for the purposes of tariffs
  full_join(RECIPROCAL_TARIFF_RATE,by = c("region" = "CTY_NAME")) %>%
  filter(long < 170 & long > -170) %>%
  filter(region != "Antarctica")


TARIFF_MAP_Graph <- TARIFF_MAP %>% 
  ggplot(aes(fill = tariff, map_id = region)) +
  geom_map(map = TARIFF_MAP, linewidth = 1) +
  expand_limits(x = TARIFF_MAP$long, y = TARIFF_MAP$lat) +
  coord_map("mercator") +
  theme_apricitas + 
  ggtitle(paste("Trump's April 2nd Tariff Hikes")) +
  scale_y_continuous(limits = c(-50,75)) +
  scale_x_continuous(limits = c(-180,180)) +
  labs(caption = "Graph created by @JosephPolitano using Census data", subtitle = "Trump Has Aggressively Raised Tariff Rates on Imports From Most of the World") +
  labs(fill = NULL) +
  scale_fill_gradientn(name= "Tariff Rate",colors = rev(c("#EE6055","#F5B041","#FFE98F", "#AED581","#00A99D","#3083DC")),label = scales::percent_format(accuracy = 1),breaks = c(0,.1,.2,.3,.4,.5), expand = c(0,0)) +
  theme_apricitas + theme(legend.position = "right", panel.grid.major=element_blank(), axis.line = element_blank(), axis.text.x = element_blank(),axis.text.y = element_blank(),plot.margin= grid::unit(c(0,0.1,-0.1,0.5), "in"), legend.key = element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank())

ggsave(dpi = "retina",plot = TARIFF_MAP_Graph, "Tariff Map Graph.png", type = "cairo-png", width = 9.02, height = 5.76, units = "in") #cairo gets rid of anti aliasing


US_COUNTRIES_HS4_IMPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/imports/hs",
  vars = c("CON_VAL_YR", "I_COMMODITY","CTY_CODE", "CTY_NAME","I_COMMODITY_LDESC","COMM_LVL"), 
  time = "2024-12",
  COMM_LVL = "HS4",
  #I_COMMODITY = "????",
  #I_COMMODITY = "*",#ALL COuntries
  #CTY_CODE = "0201", #TOTAL
  #CTY_NAME = Countries[3],
  #CTY_NAME = Countries[4],
  #CTY_NAME = Countries[5],
)

US_COUNTRIES_HS10_IMPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/imports/hs",
  vars = c("CON_VAL_YR", "I_COMMODITY","CTY_CODE", "CTY_NAME","I_COMMODITY_LDESC","COMM_LVL"), 
  time = "2024-12",
  COMM_LVL = "HS10",
  #I_COMMODITY = "????",
  #I_COMMODITY = "*",#ALL COuntries
  #CTY_CODE = "0201", #TOTAL
  #CTY_NAME = Countries[3],
  #CTY_NAME = Countries[4],
  #CTY_NAME = Countries[5],
)


US_COUNTRIES_HS8_IMPORTS_BULK <- US_COUNTRIES_HS10_IMPORTS_BULK %>%
  mutate(I_COMMODITY = substr(I_COMMODITY, 1, 8)) %>%
  select(-COMM_LVL,-COMM_LVL_1,-CTY_CODE,-time) %>%
  mutate(CON_VAL_YR = as.numeric(CON_VAL_YR)) %>%
  group_by(CTY_NAME, I_COMMODITY) %>%
  summarise(CON_VAL_YR = sum(CON_VAL_YR, na.rm = TRUE)) %>%
  ungroup()

RECIPROCAL_TARIFF_RATE_CAPS <- merge(US_IMPORTS_BULK,US_EXPORTS_BULK, by = "CTY_NAME") %>%
  transmute(CTY_NAME, tariff = (as.numeric(GEN_VAL_YR)-as.numeric(ALL_VAL_YR))/as.numeric(GEN_VAL_YR)) %>%
  mutate(tariff = round(tariff,2)/2) %>%
  mutate(tariff = round(tariff,2)) %>%
  mutate(tariff = ifelse(tariff < 0.1, 0.1, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME == "AFGHANISTAN", 0.1, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME %in% c("RUSSIA","BELARUS","CUBA","KOREA, NORTH"), 0, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME %in% c("MEXICO","CANADA"), 0, tariff)) %>%
  mutate(tariff = ifelse(CTY_NAME %in% EU_27, tariff[CTY_NAME == "EUROPEAN UNION"],tariff)) %>%
  select(CTY_NAME, tariff)

RECIPROCAL_TARIFF_ANALYSIS <- US_COUNTRIES_HS10_IMPORTS_BULK %>%
  #filter(CTY_NAME == "UNITED KINGDOM") %>%
  filter(!CTY_NAME %in% c("CAFTA-DR","CENTRAL AMERICA","AFRICA","TOTAL FOR ALL COUNTRIES", "OECD", "APEC", "NATO","USMCA (NAFTA)","NAFTA","NORTH AMERICA", "TWENTY LATIN AMERICAN REPUBLICS","LAFTA","EUROPE","ASIA","PACIFIC RIM COUNTRIES","SOUTH AMERICA","EURO AREA","ASEAN","CACM","AUSTRALIA AND OCEANIA")) %>%
  #filter(!CTY_NAME %in% c("EUROPEAN UNION")) %>% #Turn this one off if making letter analysis
  mutate(CON_VAL_YR = as.numeric(CON_VAL_YR)) %>%
  left_join(.,RECIPROCAL_TARIFF_RATE_CAPS, by = "CTY_NAME") %>%
  select(-COMM_LVL,-COMM_LVL_1,-CTY_CODE,-time) %>%
  mutate(I_COMMODITY = as.character(I_COMMODITY)) %>%
  mutate(I_COMMODITY = if_else(nchar(I_COMMODITY) == 9, paste0("0", I_COMMODITY), I_COMMODITY)) %>%
  mutate(I_COMMODITY_8 = substr(I_COMMODITY, 1, 8)) %>%
  mutate(I_COMMODITY_6 = substr(I_COMMODITY, 1, 6)) %>%
  mutate(I_COMMODITY_4 = substr(I_COMMODITY, 1, 4)) %>%
  # mutate(I_COMMODITY_8 = substr(I_COMMODITY, 1, 8)) %>%
  # mutate(I_COMMODITY_6 = substr(I_COMMODITY, 1, 6)) %>%
  # mutate(I_COMMODITY_4 = substr(I_COMMODITY, 1, 4)) %>%
  mutate(tariff = if_else(I_COMMODITY %in% c("4009120020", "4009220020", "4009320020", "4009420020", "4013100010", 
                                             "4013100020", "4016996010", "8409911040", "8409991040", "8413919010", 
                                             "8414308030", "8414596540", "8431100090", "8482105044", "8482105048", 
                                             "8482200020", "8482200030", "8482200040", "8482200061", "8482200070", 
                                             "8482200081", "8483101030", "8511100000", "8511300040", "8511300080", 
                                             "8511906020", "8511906040", "8525601010", "8536410005", "8539100010", 
                                             "8539100050", "8707100020", "8707100040", "8707905020", "8707905040", 
                                             "8707905060", "8707905080", "9029204080"), 0, tariff)) %>% #10 digit HS codes for excluded car parts
  mutate(tariff = if_else(I_COMMODITY_8 %in% c(
    "40112010", "40121940", "40122060", "40131000", "40131002",
    "70072151", "73202010", "83021000", "84073100", "84082020",
    "84099110", "84133010", "84133090", "84139110", "84139190",
    "84143080", "84145930", "84145965", "84148005", "84152000",
    "84212300", "84213200", "84254900", "84311000", "84821010",
    "84821050", "84821050", "84822000", "84822000", "84822000",
    "84822000", "84822000", "84822000", "84825000", "84831010",
    "84831030", "85013200", "85013300", "85014000", "85015100",
    "85015200", "85071000", "85079040", "85079080",
    "85111000", "85112000", "85113000", "85113000", "85114000",
    "85115000", "85118020", "85119060", "85119060", "85122020",
    "85122040", "85123000", "85124020", "85124040", "85129020",
    "85129060", "85129070", "85198120", "85269010", "85364100",
    "85391000", "85391000", "85443000", "87060025", "87060005",
    "87060015", "87071000", "87079050", "87079050", "87079050",
    "87081030", "87082100", "87082200", "87082900", "87083000",
    "87084011", "87084070", "87084075", "87085000", "87088000",
    "87089100", "87089360", "87089375", "87089400", "87089580",
    "87089953", "87089955", "87089958", "87089968", "87169050",
    "90292040"
  ), 0, tariff)) %>% #car parts
  mutate(tariff = if_else(I_COMMODITY_8 %in% c("87032201", "87032301", "87032401", "87033101", "87033201", "87033301", 
                                               "87034000", "87035000", "87036000", "87037000", "87038000", "87039001", 
                                               "87042101", "87043101", "87044100", "87045100", "87046000"), 0, tariff)) %>% #car exclusion
  
  
  mutate(tariff = if_else(I_COMMODITY_8 %in% c("05080000", "25041050", "25049000", "25101000", "25102000", "25111010", "25111050", 
                                               "25191000", "25199010", "25199020", "25249000", "25292100", "25292200", "25302010", 
                                               "25302020", "25309010", "25309020", "25309080", "26020000", "26030000", "26050000", 
                                               "26060000", "26080000", "26100000", "26110030", "26110060", "26121000", "26140030", 
                                               "26140060", "26159030", "26159060", "26161000", "26171000", "26203000", "26209950", 
                                               "27011100", "27011200", "27011900", "27012000", "27021000", "27022000", "27030000", 
                                               "27040000", "27050000", "27060000", "27071000", "27072000", "27073000", "27074000", 
                                               "27075000", "27079100", "27079910", "27079920", "27079940", "27079951", "27079955", 
                                               "27079959", "27079990", "27081000", "27082000", "27090010", "27090020", "27101215", 
                                               "27101218", "27101225", "27101245", "27101290", "27101906", "27101911", "27101916", 
                                               "27101924", "27101925", "27101926", "27101930", "27101935", "27101940", "27101945", 
                                               "27101990", "27102005", "27102010", "27102015", "27102025", "27109100", "27109905", 
                                               "27109910", "27109916", "27109921", "27109931", "27109932", "27109939", "27109945", 
                                               "27109990", "27111100", "27111200", "27111300", "27111400", "27111900", "27112100", 
                                               "27112900", "27121000", "27122000", "27129010", "27129020", "27131100", "27131200", 
                                               "27132000", "27139000", "27141000", "27149000", "27150000", "27160000", "28012000", 
                                               "28042900", "28045000", "28046100", "28048000", "28049000", "28051910", "28051920", 
                                               "28051990"), 0, tariff)) %>%
  
  mutate(tariff = if_else(I_COMMODITY_8 %in% c("28053000", "28111100", "28111910", "28112910", "28112920", "28121900", "28139010",
                                               "28152000", "28161000", "28164010", "28164020", "28170000", "28181010", "28181020",
                                               "28182000", "28183000", "28201000", "28211000", "28212000", "28220000", "28230000",
                                               "28252000", "28255030", "28256000", "28258000", "28259015", "28259030", "28259090",
                                               "28261200", "28263000", "28269090", "28273100", "28273945", "28273960", "28273990",
                                               "28274100", "28274950", "28275951", "28276010", "28276051", "28332100", "28332500",
                                               "28332700", "28332910", "28332945", "28332951", "28342100", "28342920", "28342951",
                                               "28366000", "28369100", "28369200", "28369910", "28369950", "28418000", "28419020",
                                               "28419040", "28432901", "28433000", "28439000", "28441010", "28441020", "28442000",
                                               "28443020", "28443050", "28444300", "28459001", "28461000", "28469020", "28469040",
                                               "28469080", "28492010", "28492020", "28499030", "28539010", "28539090", "29034510",
                                               "29035990", "29036990", "29037800", "29037990", "29038915", "29038920", "29038970",
                                               "29039200", "29049940", "29052990", "29053990", "29055910", "29055990", "29061950",
                                               "29062960", "29072990", "29081960", "29091918", "29092000", "29093060", "29094910",
                                               "29094915", "29094920", "29094960", "29095040", "29095045", "29095050", "29121950",
                                               "29124926", "29141900", "29144090", "29145030", "29145050", "29146200", "29146921",
                                               "29146990", "29147940", "29152930", "29153931", "29153935", "29153947", "29153990",
                                               "29159010", "29159014", "29159018", "29159020", "29159050", "29161930", "29161950",
                                               "29162050", "29163150", "29163946", "29163979", "29171300", "29171910", "29171970",
                                               "29173401", "29173930", "29181151", "29181350", "29181650", "29181960", "29181990",
                                               "29182210", "29182250", "29182330", "29182350", "29182920", "29182965", "29182975",
                                               "29183025", "29183030", "29183090", "29189930", "29189943", "29189947", "29189950",
                                               "29199030", "29199050", "29209051", "29211911", "29211961", "29212900", "29213010",
                                               "29213050", "29214290", "29214600", "29214938", "29214943", "29214945", "29214950",
                                               "29215980", "29221100", "29221400", "29221909", "29221920", "29221933", "29221960",
                                               "29221970", "29221990", "29221996", "29222927", "29222961", "29222981", "29223100",
                                               "29223925", "29223945", "29223950", "29224100", "29224250", "29224400", "29224910",
                                               "29224926", "29224930", "29224937", "29224949", "29224980", "29225007", "29225010",
                                               "29225011", "29225013", "29225014", "29225017", "29225025", "29225035", "29225040",
                                               "29225050", "29231000", "29232020", "29239001", "29241100", "29241911", "29241980",
                                               "29242116", "29242150", "29242910", "29242962", "29242971", "29242977", "29242995",
                                               "29251200", "29251942", "29251991", "29252100", "29252920", "29252960", "29252990",
                                               "29263010", "29264000", "29269014", "29269043", "29269048", "29270040", "29270050",
                                               "29280025", "29280030", "29280050", "29299020", "29299050", "29302020", "29302090",
                                               "29303060", "29309029", "29309049", "29309092", "29314900", "29315300", "29319022",
                                               "29319090", "29321400", "29321951", "29322020", "29322030", "29322050", "29329961",
                                               "29329970", "29329990", "29331100", "29331935", "29331945", "29331990", "29332100",
                                               "29332920", "29332935", "29332943", "29332945", "29332990", "29333301", "29333400",
                                               "29333500", "29333700", "29333908", "29333910", "29333920", "29333921", "29333923",
                                               "29333925", "29333927", "29333931", "29333941", "29333961", "29333992", "29334100",
                                               "29334908", "29334910", "29334915", "29334917", "29334920", "29334926", "29334930",
                                               "29334960", "29334970", "29335210", "29335290", "29335300", "29335400", "29335910",
                                               "29335915", "29335918", "29335921", "29335922", "29335936", "29335946", "29335953",
                                               "29335959"), 0, tariff)) %>%
  
  mutate(tariff = if_else(I_COMMODITY_8 %in% c("29335970", "29335980", "29335985", "29335995", "29336960", "29337200", "29337908",
                                               "29337915", "29337985", "29339100", "29339901", "29339902", "29339905", "29339906",
                                               "29339908", "29339911", "29339912", "29339916", "29339917", "29339922", "29339924",
                                               "29339926", "29339942", "29339946", "29339951", "29339953", "29339955", "29339958",
                                               "29339961", "29339965", "29339970", "29339975", "29339979", "29339982", "29339985",
                                               "29339989", "29339990", "29339997", "29341010", "29341020", "29341090", "29342040",
                                               "29342080", "29343023", "29343027", "29343043", "29343050", "29349100", "29349200",
                                               "29349901", "29349903", "29349905", "29349906", "29349907", "29349908", "29349909",
                                               "29349911", "29349912", "29349915", "29349916", "29349918", "29349920", "29349930",
                                               "29349939", "29349944", "29349947", "29349970", "29349990", "29355000", "29359006",
                                               "29359010", "29359013", "29359015", "29359020", "29359030", "29359032", "29359033",
                                               "29359042", "29359048", "29359060", "29359075", "29359095", "29362100", "29362200",
                                               "29362300", "29362401", "29362500", "29362600", "29362700", "29362800", "29362910",
                                               "29362916", "29362920", "29362950", "29369001", "29371100", "29371200", "29371900",
                                               "29372100", "29372200", "29372310", "29372325", "29372350", "29372910", "29372990",
                                               "29375000", "29379005", "29379010", "29379020", "29379040", "29379045", "29379090",
                                               "29381000", "29389000", "29391100", "29391910", "29391920", "29391950", "29392000",
                                               "29393000", "29394100", "29394200", "29394400", "29394500", "29394903", "29395900",
                                               "29396200", "29396300", "29396900", "29397200", "29397900", "29398000", "29400060",
                                               "29411010", "29411020", "29411030", "29411050", "29412010", "29412050", "29413000",
                                               "29414000", "29415000", "29419010", "29419030", "29419050", "29420005", "29420035",
                                               "29420050", "30012000", "30019001", "30021200", "30021300", "30021400", "30021500",
                                               "30024100", "30024200", "30024900", "30025100", "30025900", "30029010", "30029052",
                                               "30031000", "30032000", "30033910", "30033950", "30034100", "30034200", "30034900",
                                               "30039001", "30041010", "30041050", "30042000", "30043100", "30043200", "30043900",
                                               "30044100", "30044200", "30044900", "30045010", "30045020", "30045030", "30045040",
                                               "30045050", "30046000", "30049010", "30049092", "30063010", "30063050", "30066000",
                                               "30067000", "30069310", "30069320", "30069350", "30069360", "30069380", "31042000",
                                               "31043000", "31049001", "31051000", "31052000", "31056000", "32030080", "32041380",
                                               "32041720", "32041800", "32061100", "32061900", "34024210", "34024220", "34024290",
                                               "36069030", "38089410", "38089450", "38180000", "38249100", "38249929", "38249949",
                                               "38249955", "38249993", "39019090", "39029000", "39046100", "39059110", "39059980",
                                               "39069050", "39071000", "39072100", "39072900", "39073000", "39076100", "39076900",
                                               "39077000", "39079950", "39081000", "39100000", "39119025", "39119091", "39123100",
                                               "39123900", "39129000", "39139020", "39139050", "39140060", "40011000", "40012100",
                                               "40012200", "40012900", "40013000", "44011100", "44011200", "44012100", "44012200",
                                               "44013100", "44013200", "44013942", "44014100", "44014900", "44021000", "44022000",
                                               "44029001", "44031100", "44031200", "44032101", "44032201", "44032301", "44032401",
                                               "44032501", "44032601", "44034200", "44034902", "44039100", "44039301", "44039401",
                                               "44039501", "44039601", "44039700", "44039800", "44039901", "44041000", "44042000",
                                               "44050000", "44061100", "44061200", "44069100", "44069200", "44071100", "44071200",
                                               "44071300", "44071400", "44071900", "44072100", "44072200"), 0, tariff)) %>%
  
  mutate(tariff = if_else(I_COMMODITY_8 %in% c("44072301", "44072500", "44072600", "44072700", "44072800", "44072902", "44079100",
                                               "44079200", "44079300", "44079400", "44079500", "44079600", "44079700", "44079902",
                                               "44081001", "44083101", "44083902", "44089001", "44091005", "44091010", "44091020",
                                               "44091040", "44091045", "44091050", "44091060", "44091065", "44091090", "44092105",
                                               "44092190", "44092205", "44092210", "44092225", "44092240", "44092250", "44092260",
                                               "44092265", "44092290", "44092906", "44092911", "44092926", "44092941", "44092951",
                                               "44092961", "44092966", "44092991", "44101100", "44101200", "44101900", "44109000",
                                               "44111210", "44111220", "44111230", "44111260", "44111290", "44111310", "44111320",
                                               "44111330", "44111360", "44111390", "44111410", "44111420", "44111430", "44111460",
                                               "44111490", "44119210", "44119220", "44119230", "44119240", "44119310", "44119320",
                                               "44119330", "44119360", "44119390", "44119400", "44121005", "44121090", "44123106",
                                               "44123126", "44123142", "44123145", "44123148", "44123152", "44123161", "44123192",
                                               "44123306", "44123326", "44123332", "44123357", "44123426", "44123432", "44123457",
                                               "44123910", "44123930", "44123940", "44123950", "44124100", "44124200", "44124900",
                                               "44125110", "44125131", "44125141", "44125151", "44125210", "44125231", "44125241",
                                               "44125251", "44125980", "44125990", "44125995", "44129106", "44129110", "44129131",
                                               "44129141", "44129151", "44129207", "44129211", "44129231", "44129242", "44129252",
                                               "44129958", "44129961", "44129971", "44129981", "44129991", "44129997", "44130000",
                                               "48202000", "49011000", "49019100", "49019900", "49021000", "49029010", "49029020",
                                               "49030000", "49040000", "49052000", "49059020", "49059060", "49060000", "49111000",
                                               "49119960", "49119980", "71069110", "71081210", "71101100", "71101900", "71102100",
                                               "71102900", "71103100", "71103900", "71104100", "71104900", "71129201", "71189000",
                                               "72021110", "72021150", "72021910", "72021950", "72023000", "72024100", "72024910",
                                               "72024950", "72025000", "72028000", "72029100", "72029340", "72029380", "72042100",
                                               "74010000", "74020000", "74031100", "74031200", "74031300", "74031900", "74032100",
                                               "74032200", "74032901", "74040030", "74040060", "74050010", "74050060", "74061000",
                                               "74062000", "74071015", "74071030", "74071050", "74072115", "74072130", "74072150",
                                               "74072170", "74072190", "74072916", "74072934", "74072938", "74072940", "74072950",
                                               "74081130", "74081160", "74081900", "74082100", "74082210", "74082250", "74082910",
                                               "74082950", "74091110", "74091150", "74091910", "74091950", "74091990", "74092100",
                                               "74092900", "74093110", "74093150", "74093190", "74093910", "74093950", "74093990",
                                               "74094000", "74099010", "74099050", "74099090", "74101100", "74101200", "74102130",
                                               "74102160", "74102200", "74111010", "74111050", "74112110", "74112150", "74112200",
                                               "74112910", "74112950", "74121000", "74122000", "74130010", "74130050", "74130090",
                                               "74151000", "74152100", "74152900", "74153305", "74153310", "74153380", "74153900",
                                               "74181000", "74182010", "74182050", "74192000", "74198003", "74198006", "74198009",
                                               "74198015", "74198016", "74198017", "74198030", "74198050", "75089050", "79011100",
                                               "79011210", "79011250", "79012000", "79020000", "79070060", "80011000", "80012000",
                                               "80020000", "80070050", "81011000", "81019700", "81032000", "81033000", "81039100",
                                               "81039900", "81041100", "81041900", "81042000", "81043000", "81049000", "81052030",
                                               "81052060", "81052090", "81053000", "81059000", "81061000", "81069000", "81082000",
                                               "81083000", "81089030", "81089060", "81101000", "81102000", "81109000", "81110047",
                                               "81110049", "81122100", "81122200", "81122900", "81124110", "81124150", "81124900",
                                               "81125900", "81129210", "81129230", "81129240", "81129260", "81129265", "81129910",
                                               "81129991", "85411000", "85412100", "85412900", "85413000", "85414910", "85414970",
                                               "85414980", "85414995", "85415100", "85415900", "85419000", "85423100", "85423200",
                                               "85423300", "85423900", "85429000"), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY %in% c(
    7601103000, 7601106030, 7601106090, 7601203000, 7601206000, 7601209030,
    7601209045, 7601209060, 7601209075, 7601209080, 7601209085, 7601209095,
    7604101000, 7604103000, 7604105000, 7604210010, 7604210090, 7604291010,
    7604291090, 7604293030, 7604293060, 7604293090, 7604295020, 7604295050,
    7604295090, 7605110000, 7605190000, 7605210000, 7605290000, 7606113030,
    7606113060, 7606116000, 7606123015, 7606123025, 7606123035, 7606123045,
    7606123055, 7606123091, 7606123096, 7606126000, 7606913055, 7606913095,
    7606916055, 7606916095, 7606923025, 7606923035, 7606926055, 7606926095,
    7607113000, 7607116010, 7607116090, 7607119030, 7607119060, 7607119090,
    7607191000, 7607193000, 7607196000, 7607201000, 7607205000, 7608100030,
    7608100090, 7608200030, 7608200090, 7609000000, 7616995160, 7616995170,
    7610100010, 7610100020, 7610100030, 7610900020, 7610900040, 7610900060,
    7610900080, 7615102015, 7615102025, 7615103015, 7615103025, 7615105020,
    7615105040, 7615107125, 7615107130, 7615107155, 7615107180, 7615109100,
    7615200000, 7616109090, 7616991000, 7616995130, 7616995140, 7616995190
  ), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY %in% c(
    7614105000, 7614902030, 7614902060, 7614904000, 7614905000, 8708103030,
    8708292130, 8302103000, 8302106030, 8302106060, 8302106090, 8302200000,
    8302303010, 8302303060, 8302413000, 8302416015, 8302416045, 8302416050,
    8302416080, 8302423010, 8302423015, 8302423065, 8302496035, 8302496045,
    8302496055, 8302496085, 8302500000, 8302603000, 8302609000, 8305100010,
    8305100050, 8306300000, 8414596590, 8415908025, 8415908045, 8415908085,
    8418998005, 8418998050, 8418998060, 8419901000, 8422900680, 8473302000,
    8473305100, 8479899596, 8481909060, 8481909085, 8486900000, 8487900040,
    8487900080, 8503009520, 8508700000, 8513902000, 8515902000, 8516905000,
    8516908050, 8517710000, 8517790000, 8529907300, 8529909760, 8536908585,
    8538100000, 8541900000, 8543908885, 8547900010, 8547900020, 8547900030,
    8547900040, 8708106010, 8708106050, 8708295160, 8708806590, 8708996890,
    8716805010, 8807300015, 8807300030, 8807300060, 9013908000, 9031909195,
    9401999081, 9403100020, 9403100040, 9403200011, 9403200016, 9403200017,
    9403200035, 9403200040, 9403200046, 9403200048, 9403200050, 9403200075,
    9403200078, 9403200082, 9403200086, 9403200090, 9403991040, 9403999010,
    9403999015, 9403999020, 9403999040, 9403999045, 9405992000, 9506114080,
    9506514000, 9506516000, 9506594040, 9506702090, 9506910010, 9506910020,
    9506910030, 9506990510, 9506990520, 9506990530, 9506991500, 9506992000,
    9506992580, 9506992800, 9506995500, 9506996080, 9507302000, 9507304000,
    9507306000, 9507308000, 9507906000, 9603908050, 6603908100
  ), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY %in% c(
    7206100000,7206900000,7207110000,7207120010,7207120050,7207190030,7207190090,7207200025,
    7207200045,7207200075,7207200090,7208101500,7208103000,7208106000,7208253000,7208256000,
    7208260030,7208260060,7208270040,7208270045,7208270060,7208360030,7208360060,7208370030,
    7208370060,7208380015,7208380030,7208380090,7208390020,7208390025,7208390030,7208390090,
    7208403030,7208403060,7208406030,7208406060,7208510030,7208510045,7208510060,7208520000,
    7208530000,7208540000,7208900000,7209150000,7209160040,7209160045,7209160060,7209160070,
    7209160091,7209170040,7209170045,7209170060,7209170070,7209170091,7209181530,7209181560,
    7209182520,7209182585,7209186020,7209186090,7209250000,7209260000,7209270000,7209280000,
    7209900000,7210110000,7210120000,7210200000,7210300030,7210300060,7210410000,7210490040,
    7210490045,7210490091,7210490095,7210500020,7210500090,7210610000,7210690000,7210703000,
    7210706030,7210706060,7210706090,7210901000,7210906000,7210909000,7211130000,7211140030,
    7211140045,7211140090,7211191500,7211192000,7211193000,7211194500,7211196000,7211197530,
    7211197560,7211197590,7211231500,7211232000,7211233000,7211234500,7211236030,7211236060,
    7211236090,7211292030,7211292090,7211294500,7211296030,7211296080,7211900000,7212100000,
    7212200000,7212301030,7212301090,7212303000,7212305000,7212401000,7212405000,7212500000,
    7212600000,7213100000,7213200010,7213200080,7213913011,7213913015,7213913020,7213913093,
    7213914500,7213916000,7213990030,7213990060,7213990090,7214100000,7214200000,7214300010,
    7214300080,7214910016,7214910020,7214910060,7214910090,7214990016,7214990021,7214990026,
    7214990031,7214990036,7214990040,7214990045,7214990060,7214990075,7214990090,7215100010,
    7215100080,7215500016,7215500018,7215500020,7215500061,7215500063,7215500065,7215500090,
    7215901000,7215903000,7215905000,7216100010,7216100050,7216210000,7216220000,7216310000,
    7216320000,7216330030,7216330060,7216330090,7216400010,7216400050,7216500000,7216990010,
    7216990090,7217101000,7217102000,7217103000,7217104040,7217104045,7217104090,7217105030,
    7217105090,7217106000,7217107000,7217108010,7217108020,7217108025,7217108030,7217108045,
    7217108060,7217108075,7217108090,7217109000,7217201500,7217203000,7217204510,7217204520,
    7217204530,7217204540,7217204550,7217204560,7217204570,7217204580,7217206000,7217207500,
    7217301530,7217301560,7217303000,7217304504,7217304511,7217304520,7217304530,7217304541,
    7217304550,7217304560,7217304590,7217306000,7217307500,7217901000,7217905030,7217905060,
    7217905090,7218100000,7218910015,7218910030,7218910060,7218990015,7218990030,7218990045,
    7218990060,7218990090,7229200015,7229200090,7229900500,7229901000,7229905006,7229905008,7229905016,7229905031,
    7229905051,7229909000,7301100000,7302101010,7302101015,7302101025,7302101035,7302101045,
    7302101055,7302101065,7302101075,7302105020,7302105040,7302105060,7302400000,7302901000,
    7302909000,7304110020,7304110050,7304110080,7304191020,7304191030,7304191045,7304191060,
    7304191080,7304195020,7304195050,7304195080,7304220030,7304220045,7304220060,7304233000,
    7304236030,7304236045,7304236060,7304243010,7304243020,7304243030,7304243040,7304243045,
    7304243080,7304244010,7304244020,7304244030,7304244040,7304244050,7304244060,7304244080,
    7304246015,7304246030,7304246045,7304246060,7304246075,7304291010,7304291020,7304291030,
    7304291040,7304291050,7304291060,7304291080,7304292010,7304292020,7304292030,7304292040,
    7304292050,7304292060,7304292080,7304293110,7304293120,7304293130,7304293140,7304293150,
    7304293160,7304293180,7304294110,7304294120,7304294130,7304294140,7304294150,7304294160,
    7304294180,7304295015,7304295030,7304295045,7304295060,7304295075,7304296115,7304296130,
    7304296145,7304296160,7304296175,7304313000,7304316010,7304316050,7304390002,7304390004,
    7304390006,7304390008,7304390016,7304390020,7304390024,7304390028,7304390032,7304390036,
    7304390040,7304390044,7304390048,7304390052,7304390056,7304390062,7304390068,7304390072,
    7304390076,7304390080,7304413005,7304413015,7304413045,7304416005,7304416015,7304416045,
    7304490005,7304490015,7304490045,7304490060,7304511000,7304515005,7304515015,7304515045,
    7304515060,7304591000,7304592030,7304592040,7304592045,7304592055,7304592060,7304592070,
    7304592080,7304596000,7304598010,7304598015,7304598020,7304598025,7304598030,7304598035,
    7304598040,7304598045,7304598050,7304598055,7304598060,7304598065,7304598070,7304598080,
    7304901000,7304903000,7304905000,7304907000,7305111030,7305111060,7305115000,7305121030,
    7305121060,7305125000,7305191030,7305191060,7305195000,7305202000,7305204000,7305206000,
    7305208000,7305312000,7305314000,7305316010,7305316090,7305391000,7305395000,7305901000,
    7305905000,7306101010,7306101050,7306105010,7306105050,7306110010,7306110050,7306191010,
    7306191050,7306195110,7306195150,7306213000,7306214000,7306218010,7306218050,7306291030,
    7306291090,7306292000,7306293100,7306294100,7306296010,7306296050,7306298110,7306298150,
    7306301000,7306303000,7306305010,7306305015,7306305020,7306305025,7306305028,7306305032,
    7306305035,7306305040,7306305055,7306305085,7306305090,7306401010,7306401015,7306401090,
    7306405005,7306405015,7306405040,7306405042,7306405044,7306405062,7306405064,7306405080,
    7306405085,7306405090,7306501000,7306503000,7306505010,7306505030,7306505050,7306505070,
    7306611000,7306613000,7306615000,7306617030,7306617060,7306691000,7306693000,7306695000,
    7306697030,7306697060,7306901000,7306905000.7301201000,7301205000,7302300000,7307211000,7307221000,7307225000,7307230030,7307230090,
    7307290030,7307290090,7307911000,7307913000,7307915010,7307915030,7307915050,7307915070,
    7307923010,7307923030,7307929000,7307933010,7307933040,7307936000,7307939010,7307939040,
    7307939060,7307991000,7307993000,7307995015,7307995045,7307995060,7308100000,7308200020,
    7308200090,7308301000,7308305015,7308305025,7308305050,7308400000,7308903000,7308906000,
    7308907000,7308909530,7308909560,7308909590,7309000030,7309000090,7310100005,7310100015,
    7310100090,7310210025,7310210050,7310290020,7310290030,7310290055,7310290065,7311000030,
    7311000060,7311000090,7312100500,7312101030,7312101050,7312101070,7312102000,7312103005,
    7312103010,7312103012,7312103020,7312103045,7312103065,7312103070,7312103074,7312103080,
    7312105000,7312106030,7312106060,7312107000,7312108000,7312109030,7312109060,7312109090,
    7312900000,7313000000,7314121000,7314122000,7314123000,7314126000,7314129000,7314141000,
    7314142000,7314143000,7314146000,7314149000,7314190100,7314200000,7314311000,7314315010,
    7314315080,7314390000,7314410030,7314410040,7314410045,7314410080,7314420030,7314420060,
    7314493000,7314496000,7314500000,7315110005,7315110010,7315110045,7315110060,7315120020,
    7315120040,7315120060,7315120080,7315190000,7315201000,7315205000,7315810000,7315821000,
    7315823000,7315825000,7315827000,7315891000,7315893000,7315895000,7315900000,7316000000,
    7317001000,7317002000,7317003000,7317005501,7317005502,7317005503,7317005505,7317005507,
    7317005508,7317005511,7317005518,7317005519,7317005520,7317005530,7317005540,7317005550,
    7317005560,7317005570,7317005580,7317005590,7317006530,7317006560,7317007500,7318110000,
    7318120000,7318130030,7318130060,7318141030,7318141060,7318145020,7318145080,7318152010,
    7318152020,7318152030,7318152041,7318152046,7318152051,7318152055,7318152061,7318152065,
    7318152091,7318152095,7318154000,7318155030,7318155051,7318155056,7318155090,7318156010,
    7318156040,7318156070,7318156080,7318158020,7318158030,7318158045,7318158055,7318158066,
    7318158069,7318158082,7318158085,7318160015,7318160030,7318160045,7318160060,7318160085,
    7318190000,7318210030,7318210090,7318220000,7318230000,7318240000,7318290000,7319402010,
    7319402050,7319403000,7319405010,7319405050,7319901000,7319909000,7320103000,7320106015,
    7320106060,7320109015,7320109060,7320201000,7320205010,7320205020,7320205045,7320205060,
    7320901000,7320905010,7320905020,7320905060,7321111030,7321111060,7321113010,7321113020,
    7321113050,7321116000,7321120000,7321190020,7321190040,7321190060,7321190080,7321811000,
    7321815000,7321821000,7321825000,7321890010,7321890050,7321901000,7321902000,7321904000,
    7321905000,7321906040,7321906060,7321906090,7326908688
  ), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY %in% c(
    7317003000,7317005503,7317005505,7317005507,7317005560,7317005580,7317006560,
    8708103020,8708292120,8431310020,8431310040,8431310060,8431420000,8431491010,
    8431491060,8431491090,8431499005,8431499010,8431499015,8431499020,8431499025,
    8431499030,8431499035,8431499036,8431499038,8431499044,8431499045,8431499050,
    8431499055,8431499081,8431499084,8431499090,8431499095,8432100020,8432100040,
    8432100060,8432900010,8432900020,8432900040,8432900050,8432900060,8432900081,
    8547900010,8547900020,8547900030,8547900040,9403200011,9403200016,9403200017,
    9403200035,9403200040,9403200046,9403200048,9403200050,9403200075,9403200078,
    9403200082,9403200086,9403200090,9403992040,9403992080,9403994005,9403994010,
    9403994080,9406200000,9406900110,9406900120,9406900130,9406900150,9406900190
  ), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY_6 %in% c("732010", "830230", "840732", "840733", "840734", "850132", "850133", "850134", "850140",
                                             "850151", "850152", "852721", "852729", "853710", "853720", "870822",
                                             "870829", "870830", "870850", "870870", "870880", "870891", "870894", "870895", "901510",
                                             "902910"), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY %in% c("8507600010","8507600010"), 0, tariff)) %>% #only motor vehicle batteries
  #mutate(tariff = if_else(I_COMMODITY_4 %in% c("8404"), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY_4 %in% c("8707"), 0, tariff)) %>%
  mutate(tariff = if_else(I_COMMODITY_4 %in% c("8471","8486","8524","8542"), 0, tariff)) %>% #April 11th Electronics Exemption
  mutate(tariff = if_else(I_COMMODITY_6 %in% c("847330","851713","851762","852351","852852","854110","854121","854129","854130","854151","854159","854190"), 0, tariff)) %>% #April 11th Electronics Exemption
  mutate(tariff = if_else(I_COMMODITY_8 %in% c("85414910","85414970","85414980","85414995"), 0, tariff)) %>% #April 11th Electronics Exemption
  mutate(tariff_val = CON_VAL_YR*tariff) 
  
HS4_LIST <- filter(US_COUNTRIES_HS4_IMPORTS_BULK, CTY_NAME == "TOTAL FOR ALL COUNTRIES") %>%
  select(I_COMMODITY,I_COMMODITY_LDESC)
  
AGGREGATE_TARIFFS <- RECIPROCAL_TARIFF_ANALYSIS %>%
  #filter((CTY_NAME %in% EU_27)) %>%
  #filter(!(CTY_NAME %in% c("CHINA", "HONG KONG","MACAU"))) %>%
  mutate(CON_VAL_YR = if_else(tariff == 0, 0, CON_VAL_YR)) %>%
  filter(tariff > 0) %>%
  summarize(value = sum(CON_VAL_YR, na.rm = TRUE),tariff_val = sum(tariff_val, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(effective_tariff = tariff_val/value, round_tariff = round(effective_tariff,2))

AGGREGATE_TARIFFS$value[1]

options(scipen=999)

TARIFF_BY_CATEGORY <- RECIPROCAL_TARIFF_ANALYSIS %>%
  filter(!(tariff_val == 0 & I_COMMODITY_4 == 8541)) %>% #excluding semiconductors from 4 digit category to just capture solar panels
  group_by(I_COMMODITY_4) %>%
  summarize(value = sum(CON_VAL_YR, na.rm = TRUE),tariff_val = sum(tariff_val, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(effective_tariff = tariff_val/value) %>%
  transmute(I_COMMODITY = I_COMMODITY_4, value, tariff_val, effective_tariff, round_tariff = round(effective_tariff,2)) %>%
  right_join(., HS4_LIST, by = "I_COMMODITY") %>%
  filter(I_COMMODITY <= 9800)

TARIFF_BY_COUNTRY <- RECIPROCAL_TARIFF_ANALYSIS %>%
  mutate(value = if_else(tariff_val == 0, 0, CON_VAL_YR)) %>%
  mutate(country = case_when(
    CTY_NAME %in% c("HONG KONG", "MACAU") ~ "CHINA",
    TRUE ~ CTY_NAME
  )) %>%
  group_by(CTY_NAME) %>%
  summarize(tariff = max(tariff,na.rm = TRUE), value = sum(value, na.rm = TRUE),tariff_val = sum(tariff_val, na.rm = TRUE), Total_Imports = sum(CON_VAL_YR, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(effective_tariff = tariff_val/Total_Imports, round_tariff = round(effective_tariff,2)) %>%
  mutate(region = case_when(
    CTY_NAME %in% c("UNITED STATES", "CANADA", "MEXICO", "BRAZIL", "ARGENTINA", "CHILE", "COLOMBIA", "PERU", "URUGUAY", "PARAGUAY", "VENEZUELA", "ECUADOR", "BOLIVIA", "PANAMA", "COSTA RICA", "GUATEMALA", "HONDURAS", "EL SALVADOR", "NICARAGUA", "BELIZE", "JAMAICA", "TRINIDAD AND TOBAGO", "BARBADOS", "BAHAMAS", "GUYANA", "SURINAME", "HAITI", "DOMINICAN REPUBLIC", "CUBA",
                   "ANGUILLA", "ANTIGUA AND BARBUDA", "ARUBA", "BERMUDA", "BRITISH VIRGIN ISLANDS", "CAYMAN ISLANDS", "CURACAO", "DOMINICA", "FALKLAND ISLANDS (ISLAS MALVINAS)", "FRENCH GUIANA", "GRENADA", "GUADELOUPE", "MARTINIQUE", "MONTSERRAT", "PUERTO RICO", "SINT MAARTEN", "ST HELENA", "ST KITTS AND NEVIS", "ST LUCIA", "ST PIERRE AND MIQUELON", "ST VINCENT AND THE GRENADINES", "TURKS AND CAICOS ISLANDS", "VIRGIN ISLANDS (U.S.)") ~ "Americas",
    CTY_NAME %in% c("AUSTRALIA", "NEW ZEALAND", "FIJI", "PAPUA NEW GUINEA", "SAMOA", "TONGA", "VANUATU", "KIRIBATI", "MICRONESIA", "PALAU", "SOLOMON ISLANDS", "TUVALU", "NAURU", "MARSHALL ISLANDS",
                   "BRITISH INDIAN OCEAN TERRITORIES", "CHRISTMAS ISLAND", "COCOS (KEELING) ISLANDS", "COOK ISLANDS", "FRENCH POLYNESIA", "FRENCH SOUTHERN AND ANTARCTIC LANDS", "HEARD AND MCDONALD ISLANDS", "NIUE", "NEW CALEDONIA", "NORFOLK ISLAND", "PITCAIRN ISLANDS", "REUNION", "TOKELAU", "WALLIS AND FUTUNA") ~ "Oceania",
    CTY_NAME %in% c("UNITED KINGDOM", "GERMANY", "FRANCE", "ITALY", "SPAIN", "NETHERLANDS", "SWEDEN", "POLAND", "AUSTRIA", "BELGIUM", "CZECH REPUBLIC", "DENMARK", "FINLAND", "GREECE", "HUNGARY", "IRELAND", "NORWAY", "PORTUGAL", "SLOVAKIA", "SLOVENIA", "SWITZERLAND", "ICELAND", "ESTONIA", "LATVIA", "LITHUANIA", "LUXEMBOURG", "MALTA", "ALBANIA", "ANDORRA", "BOSNIA AND HERZEGOVINA", "BULGARIA", "CROATIA", "CYPRUS", "KOSOVO", "LIECHTENSTEIN", "MACEDONIA", "MONACO", "MONTENEGRO", "ROMANIA", "SAN MARINO", "SERBIA", "UKRAINE", "RUSSIA",
                   "ARMENIA", "AZERBAIJAN", "GEORGIA", "BELARUS", "MOLDOVA","SVALBARD, JAN MAYEN ISLAND","GREENLAND","GIBRALTAR","FAROE ISLANDS") ~ "Europe",
    CTY_NAME %in% c("CHINA", "JAPAN", "KOREA, SOUTH", "KOREA, NORTH", "TAIWAN", "MONGOLIA", "HONG KONG", "MACAU") ~ "East Asia",
    CTY_NAME %in% c("INDIA", "PAKISTAN", "BANGLADESH", "SRI LANKA", "NEPAL", "BHUTAN", "AFGHANISTAN", "MALDIVES") ~ "South Asia",
    CTY_NAME %in% c("INDONESIA", "VIETNAM", "THAILAND","MAURITIUS","PHILIPPINES", "MALAYSIA", "SINGAPORE", "BURMA", "CAMBODIA", "LAOS", "BRUNEI", "TIMOR-LESTE") ~ "Southeast Asia",
    CTY_NAME %in% c("NIGERIA", "KENYA", "SOUTH AFRICA", "ETHIOPIA", "GHANA", "TANZANIA", "UGANDA", "ANGOLA", "MOZAMBIQUE", "ZAMBIA","MADAGASCAR","MAYOTTE","ZIMBABWE", "CAMEROON", "SENEGAL", "BOTSWANA", "NAMIBIA", "RWANDA", "MALAWI", "BURKINA FASO", "MALI", "NIGER", "CHAD", "BENIN", "TOGO", "SIERRA LEONE", "LIBERIA", "GUINEA", "GUINEA-BISSAU", "CENTRAL AFRICAN REPUBLIC", "CONGO (KINSHASA)", "CONGO (BRAZZAVILLE)", "EQUATORIAL GUINEA", "GABON", "COMOROS", "LESOTHO", "ESWATINI", "MAURITANIA", "GAMBIA", "SOUTH SUDAN", "SOMALIA", "ERITREA", "DJIBOUTI", "CABO VERDE", "SAO TOME AND PRINCIPE", "SEYCHELLES", "COTE D'IVOIRE", "BURUNDI", "SUDAN") ~ "Sub-Saharan Africa",
    CTY_NAME %in% c("KAZAKHSTAN", "KYRGYZSTAN", "TAJIKISTAN", "TURKMENISTAN", "UZBEKISTAN") ~ "Middle East & North Africa",
    CTY_NAME %in% c("EGYPT", "SAUDI ARABIA", "IRAN", "IRAQ", "MOROCCO", "ALGERIA", "TUNISIA", "JORDAN", "LEBANON", "SYRIA", "UNITED ARAB EMIRATES", "QATAR", "OMAN", "BAHRAIN", "ISRAEL", "TURKEY", "KUWAIT", "YEMEN", "LIBYA", "GAZA STRIP ADMINISTERED BY ISRAEL", "WEST BANK ADMINISTERED BY ISRAEL", "VATICAN CITY") ~ "Middle East & North Africa",
    TRUE ~ "Other"
  ))

TARIFF_BY_CATEGORY_SUMMARY <- TARIFF_BY_CATEGORY %>%
  arrange(desc(tariff_val)) %>%
  slice(1:10) %>%
  mutate(I_COMMODITY_LDESC = c("Phones","Computers","Computer Parts","Batteries","Solar Panels","Transformers","Toys","Medical Instruments","Chairs & Seats","Furniture")) %>%
  arrange(desc(value)) %>%
  mutate(I_COMMODITY_LDESC = paste0(as.character(I_COMMODITY_LDESC), ": ", round_tariff*100, "%")) %>%
  mutate(I_COMMODITY_LDESC = replace(I_COMMODITY_LDESC, 1, paste0(I_COMMODITY_LDESC[1], " Tariff"))) %>%
  mutate(I_COMMODITY_LDESC1 = sub(":.*", "", I_COMMODITY_LDESC)) %>%
  mutate(I_COMMODITY_LDESC1 = factor(I_COMMODITY_LDESC1, levels = rev(I_COMMODITY_LDESC1)))

TARIFF_BY_CATEGORY_RECIPROCAL_GRAPH <- ggplot(data = TARIFF_BY_CATEGORY_SUMMARY, aes(x = I_COMMODITY_LDESC1, y = value/1000000000)) +
  annotate("hline", y = 0, yintercept = 0, color = "white", size = .5) +
  geom_bar(stat = "identity", position = "dodge", color = NA, fill = "#00A99D") +
  geom_text(aes(label = paste0(" ",I_COMMODITY_LDESC)), 
            position = position_stack(vjust = 0), # Centers text within the bars
            angle = 0, 
            hjust = 0, 
            size = 7,
            color = "white",
            fontface = "bold") +
  xlab(NULL) +
  ggtitle("Major Imports Hit By Trump's April 2nd Tariffs") +
  ylab("US Imports in Category, 2024") +
  scale_y_continuous(labels = scales::dollar_format(accuracy = 1, suffix = "B"), limits = c(0,150), expand = c(0,0)) +
  #labs(subtitle = "By % of US Imports") +
  labs(caption = "Graph created by @JosephPolitano using Census Data. Note: Data by HS Code. Tariff Calculated as Weighted Avg of 2024 Import Mix", subtitle = "Trump's Tariffs Hit Electronics, Electrical, and Medical Technology Imports Espectially Hard") +
  theme_apricitas + theme(legend.position = "none", plot.margin= grid::unit(c(0.2, .2, 0.2, .2), "in"), axis.text.y = element_blank()) +
  coord_flip()

ggsave(dpi = "retina",plot = TARIFF_BY_CATEGORY_RECIPROCAL_GRAPH, "Tariff By Category Reciprocal Graph.png", type = "cairo-png", width = 9.02, height = 5.76, units = "in")

TARIFF_BY_CATEGORY_RECIPROCAL_RAINBOW_GRAPH <- ggplot(data = TARIFF_BY_CATEGORY_SUMMARY, aes(x = I_COMMODITY_LDESC1, y = value/1000000000, fill = round_tariff)) +
  annotate("hline", y = 0, yintercept = 0, color = "white", size = .5) +
  geom_bar(stat = "identity", position = "dodge", color = NA) +
  geom_text(aes(label = sub("^.*?(?=\\d)", " ", I_COMMODITY_LDESC, perl = TRUE)), 
            position = position_stack(vjust = 0), 
            angle = 0, 
            hjust = 0, 
            size = 7, 
            color = "black", 
            fontface = "bold") +
  xlab(NULL) +
  ggtitle("Major Imports Hit By Trump's\nApril 2nd Tariff Increases") +
  ylab("US Imports in Category, 2024") +
  scale_y_continuous(labels = scales::dollar_format(accuracy = 1, suffix = "B"), limits = c(0,150), expand = c(0,0)) +
  #labs(subtitle = "By % of US Imports") +
  scale_fill_gradientn(name= "Tariff Rate",colors = rev(c("#EE6055","#F5B041","#FFE98F", "#AED581","#00A99D","#3083DC")),label = scales::percent_format(accuracy = 1),limits = c(.09,.4),breaks = c(.1,.2,.3,.4), expand = c(0,0)) +
  labs(caption = "Graph created by @JosephPolitano using Census Data. Note: Data by 4-Digit HS Code. Tariff Calculated as Weighted Avg of 2024 Import Mix", subtitle = "Trump's Tariffs Hit Electronics, Electrical, and Medical Technology Imports") +
  theme_apricitas + theme(legend.position = c(.5,.4), plot.margin= grid::unit(c(0.2, .2, 0.2, .2), "in"), axis.text.y = element_text(size = 16, color = "white"), axis.title.x = element_text(size = 14, color = "white")) +
  coord_flip()

ggsave(dpi = "retina",plot = TARIFF_BY_CATEGORY_RECIPROCAL_RAINBOW_GRAPH, "Tariff By Category Reciprocal Graph.png", type = "cairo-png", width = 9.02, height = 5.76, units = "in")


TARIFF_BY_COUNTRY_RECIPROCAL_GRAPH <- ggplot(data = TARIFF_BY_COUNTRY, aes(x = tariff, y = value/1000000000, fill = region)) +
  annotate("hline", y = 0, yintercept = 0, color = "white", size = .5) +
  geom_bar(stat = "identity", position = "stack", color = NA) +
  xlab(NULL) +
  ggtitle("Distribution of Trump's April 2nd Tariffs") +
  ylab("Affected US Imports by Country, 2024") +
  scale_y_continuous(labels = scales::dollar_format(accuracy = 1, suffix = "B"), limits = c(0,400), expand = c(0,0)) +
  scale_x_continuous(labels = scales::percent_format(accuracy =1), limits = c(0,.5), breaks = c(.1,.2,.3,.4,.5),expand = c(0,0)) +
  #labs(subtitle = "By % of US Imports") +
  annotate(geom = "segment", x = .20, xend = .175, y = 330, yend = 350, color = "white", lwd = .75) +
  annotate(geom = "text", label = "EU", x = .16, y = 350, color ="white",size = 4, lineheight = unit(0.85,"cm")) +
  annotate(geom = "segment", x = .34, xend = .315, y = 366, yend = 386, color = "white", lwd = .75) +
  annotate(geom = "text", label = "China", x = .29, y = 386, color ="white",size = 4, lineheight = unit(0.85,"cm")) +
  annotate(geom = "segment", x = .45, xend = .425, y = 132, yend = 152, color = "white", lwd = .75) +
  annotate(geom = "text", label = "Vietnam", x = .39, y = 152, color ="white",size = 4, lineheight = unit(0.85,"cm")) +
  scale_fill_manual(name= NULL,values = rev(c("#FF8E72","#6A4C93","#A7ACD9","#3083DC","#9A348E","#00A99D","#EE6055","#FFE98F"))) +
  labs(caption = "Graph created by @JosephPolitano using Census Data.", subtitle = "April 2nd Tariffs Would've Been a 27% Tax on Affected Imports & 13% on the Whole Import Mix") +
  theme_apricitas + theme(legend.position = "right", plot.margin= grid::unit(c(0.2, .2, 0.2, .2), "in"))

ggsave(dpi = "retina",plot = TARIFF_BY_COUNTRY_RECIPROCAL_GRAPH, "Tariff By Country Reciprocal Graph.png", type = "cairo-png", width = 9.02, height = 5.76, units = "in")

