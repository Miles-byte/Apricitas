JUNE_HS4_IMPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/imports/hs",
  vars = c("CON_VAL_MO","CAL_DUT_MO","I_COMMODITY","I_COMMODITY_LDESC","COMM_LVL","RP"), 
  time = "2025-07",
  COMM_LVL = "HS4",
)

JUNE_HS4_IMPORTS_NO_TARIFF <- JUNE_HS4_IMPORTS_BULK %>%
  filter(CAL_DUT_MO == 0) %>%
  mutate(across(where(is.character) & !matches("I_COMMODITY_LDESC"), as.numeric)) %>%
  group_by(I_COMMODITY) %>%
  summarise(I_COMMODITY_LDESC, CON_VAL_MO = sum(CON_VAL_MO)) %>%
  unique() %>%
  ungroup() %>%
  mutate(Category = case_when(
    I_COMMODITY %in% c("8471","8473","8542","8528","8523","8524") ~ "Computers & Parts",
    I_COMMODITY %in% c("8517") ~ "Smartphones",
    I_COMMODITY %in% c("2709","2710","2713","2716","2707","2701","2703","2715","2712","2714","2704","2708","2702","2706") ~ "Energy",
    I_COMMODITY %in% c("2903","2904","2905","2906","2907","2908","2909","2912","2914","2915","2916","2917","2918","2919","2920","2921","2922","2923","2924","2925","2926","2927","2928","2929","2930","2931","2932","2933","2934","2935","2936","2937","2938","2939","2940","2941","2942","3001","3002","3003","3004","3006","3104","3105","3203","3204","3206","3402","3606","3808","3818","3824","3901","3902","3904","3905","3906","3907","3907","3907","3907","3907","3908","3910","3911","3912","3913","3914") ~ "Pharmaceuticals",
    I_COMMODITY %in% c("7108","7106") ~ "Precious Metals",
    I_COMMODITY %in% c("7401","7402","7403","7404","7405","7406","7407","7408","7409","7410","7410","7410","7410","7411","7411","7411","7411","7411","7412","7412","7413","7413","7413","7415","7415","7415","7415","7415","7418","7418","7419","7419","7419","7419","7419","7419") ~ "Copper & Related",
    I_COMMODITY %in% c("4401","4402","4403","4404","4405","4406","4407","4408","4409","4410","4411","4412","4413","4820","4901","4902","4903","4904","4905","4906","4911","4001") ~ "Lumber & Related",
    I_COMMODITY %in% c("8486") ~ "Semiconductor Equipment",
    I_COMMODITY %in% c("7110","7112","7202","7202","7202","7202","7202","7202","7202","7202","7202","7202","7202","7508","7901","7901","7901","7901","7902","7907","8001","8001","8002","8007","8101","8101","8103","8103","8103","8103","8104","8104","8104","8104","8104","8105","8105","8105","8105","8105","8106","8106","8108","8108","8108","8108","8110","8110","8110","8111","8111","8112","8112","8112","8112","8112","8112","8112","8112","8112","8112","2801","2804","2804","2804","2804","2804","2805","2805","2805","2805","2811","2811","2811","2811","2812","2813","2815","2816","2816","2816","2817","2818","2818","2818","2818","2820","2821","2821","2822","2823","2825","2825","2825","2825","2825","2825","2826","2826","2826","2827","2827","2827","2827","2827","2827","2827","2827","2833","2833","2833","2833","2833","2833","2834","2834","2834","2836","2836","2836","2836","2836","2841","2841","2841","2843","2843","2843","2844","2844","2844","2844","2844","2844","2845","2846","2846","2846","2849","2849","2849","2853","2853","0508","2504","2504","2510","2510","2511","2511","2519","2519","2519","2524","2529","2529","2530","2530","2530","2530","2530","2602","2603","2605","2606","2608","2610","2611","2611","2612","2614","2614","2615","2615","2616","2617","2620","2620") ~ "Critical Minerals",
    TRUE ~ "None"
  )) %>%
  group_by(Category) %>%
  summarise(Category, CON_VAL_MO = sum(CON_VAL_MO)) %>%
  unique()
  

JULY_MEXICO_IMPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/imports/hs",
  vars = c("CON_VAL_MO","CAL_DUT_MO","CTY_CODE","CTY_NAME","I_COMMODITY","I_COMMODITY_LDESC","COMM_LVL","RP"), 
  time = "2025-07",
  COMM_LVL = "HS4",
  CTY_CODE = "2010",
)

JULY_MEXICO_IMPORTS <- JULY_MEXICO_IMPORTS_BULK %>%
  filter(CAL_DUT_MO == 0) %>%
  mutate(across(where(is.character) & !matches("I_COMMODITY_LDESC"), as.numeric)) %>%
  group_by(I_COMMODITY) %>%
  summarise(I_COMMODITY_LDESC, CON_VAL_MO = sum(CON_VAL_MO)) %>%
  unique() %>%
  ungroup() %>%
  mutate(Category = case_when(
    I_COMMODITY %in% c("8471","8473","8542","8528","8523","8524") ~ "Computers & Parts",
    I_COMMODITY %in% c("8517") ~ "Smartphones",
    I_COMMODITY %in% c("2709","2710","2713","2716","2707","2701","2703","2715","2712","2714","2704","2708","2702","2706") ~ "Energy",
    I_COMMODITY %in% c("2903","2904","2905","2906","2907","2908","2909","2912","2914","2915","2916","2917","2918","2919","2920","2921","2922","2923","2924","2925","2926","2927","2928","2929","2930","2931","2932","2933","2934","2935","2936","2937","2938","2939","2940","2941","2942","3001","3002","3003","3004","3006","3104","3105","3203","3204","3206","3402","3606","3808","3818","3824","3901","3902","3904","3905","3906","3907","3907","3907","3907","3907","3908","3910","3911","3912","3913","3914") ~ "Pharmaceuticals",
    I_COMMODITY %in% c("7108","7106") ~ "Precious Metals",
    I_COMMODITY %in% c("7401","7402","7403","7404","7405","7406","7407","7408","7409","7410","7410","7410","7410","7411","7411","7411","7411","7411","7412","7412","7413","7413","7413","7415","7415","7415","7415","7415","7418","7418","7419","7419","7419","7419","7419","7419") ~ "Copper & Related",
    I_COMMODITY %in% c("4401","4402","4403","4404","4405","4406","4407","4408","4409","4410","4411","4412","4413","4820","4901","4902","4903","4904","4905","4906","4911","4001") ~ "Lumber & Related",
    I_COMMODITY %in% c("8486") ~ "Semiconductor Equipment",
    I_COMMODITY %in% c("7110","7112","7202","7202","7202","7202","7202","7202","7202","7202","7202","7202","7202","7508","7901","7901","7901","7901","7902","7907","8001","8001","8002","8007","8101","8101","8103","8103","8103","8103","8104","8104","8104","8104","8104","8105","8105","8105","8105","8105","8106","8106","8108","8108","8108","8108","8110","8110","8110","8111","8111","8112","8112","8112","8112","8112","8112","8112","8112","8112","8112","2801","2804","2804","2804","2804","2804","2805","2805","2805","2805","2811","2811","2811","2811","2812","2813","2815","2816","2816","2816","2817","2818","2818","2818","2818","2820","2821","2821","2822","2823","2825","2825","2825","2825","2825","2825","2826","2826","2826","2827","2827","2827","2827","2827","2827","2827","2827","2833","2833","2833","2833","2833","2833","2834","2834","2834","2836","2836","2836","2836","2836","2841","2841","2841","2843","2843","2843","2844","2844","2844","2844","2844","2844","2845","2846","2846","2846","2849","2849","2849","2853","2853","0508","2504","2504","2510","2510","2511","2511","2519","2519","2519","2524","2529","2529","2530","2530","2530","2530","2530","2602","2603","2605","2606","2608","2610","2611","2611","2612","2614","2614","2615","2615","2616","2617","2620","2620") ~ "Critical Minerals",
    TRUE ~ "None"
  )) %>%
  group_by(Category) %>%
  summarise(Category, CON_VAL_MO = sum(CON_VAL_MO)) %>%
  unique() %>%
  filter(Category == "None") %>%
  mutate(Category = "Mexico (USMCA-compliant)")

JULY_CANADA_IMPORTS_BULK <- getCensus(
  name = "timeseries/intltrade/imports/hs",
  vars = c("CON_VAL_MO","CAL_DUT_MO","CTY_CODE","I_COMMODITY","COMM_LVL","RP"), 
  time = "2025-07",
  COMM_LVL = "HS4",
  CTY_CODE = "1220",
)

JULY_CANADA_IMPORTS <- JULY_CANADA_IMPORTS_BULK %>%
  filter(CAL_DUT_MO == 0) %>%
  mutate(across(where(is.character) & !matches("I_COMMODITY_LDESC"), as.numeric)) %>%
  group_by(I_COMMODITY) %>%
  summarise(CON_VAL_MO = sum(CON_VAL_MO)) %>%
  unique() %>%
  ungroup() %>%
  mutate(Category = case_when(
    I_COMMODITY %in% c("8471","8473","8542","8528","8523","8524") ~ "Computers & Parts",
    I_COMMODITY %in% c("8517") ~ "Smartphones",
    I_COMMODITY %in% c("2709","2710","2713","2716","2707","2701","2703","2715","2712","2714","2704","2708","2702","2706") ~ "Energy",
    I_COMMODITY %in% c("2903","2904","2905","2906","2907","2908","2909","2912","2914","2915","2916","2917","2918","2919","2920","2921","2922","2923","2924","2925","2926","2927","2928","2929","2930","2931","2932","2933","2934","2935","2936","2937","2938","2939","2940","2941","2942","3001","3002","3003","3004","3006","3104","3105","3203","3204","3206","3402","3606","3808","3818","3824","3901","3902","3904","3905","3906","3907","3907","3907","3907","3907","3908","3910","3911","3912","3913","3914") ~ "Pharmaceuticals",
    I_COMMODITY %in% c("7108","7106") ~ "Precious Metals",
    I_COMMODITY %in% c("7401","7402","7403","7404","7405","7406","7407","7408","7409","7410","7410","7410","7410","7411","7411","7411","7411","7411","7412","7412","7413","7413","7413","7415","7415","7415","7415","7415","7418","7418","7419","7419","7419","7419","7419","7419") ~ "Copper & Related",
    I_COMMODITY %in% c("4401","4402","4403","4404","4405","4406","4407","4408","4409","4410","4411","4412","4413","4820","4901","4902","4903","4904","4905","4906","4911","4001") ~ "Lumber & Related",
    I_COMMODITY %in% c("8486") ~ "Semiconductor Equipment",
    I_COMMODITY %in% c("7110","7112","7202","7202","7202","7202","7202","7202","7202","7202","7202","7202","7202","7508","7901","7901","7901","7901","7902","7907","8001","8001","8002","8007","8101","8101","8103","8103","8103","8103","8104","8104","8104","8104","8104","8105","8105","8105","8105","8105","8106","8106","8108","8108","8108","8108","8110","8110","8110","8111","8111","8112","8112","8112","8112","8112","8112","8112","8112","8112","8112","2801","2804","2804","2804","2804","2804","2805","2805","2805","2805","2811","2811","2811","2811","2812","2813","2815","2816","2816","2816","2817","2818","2818","2818","2818","2820","2821","2821","2822","2823","2825","2825","2825","2825","2825","2825","2826","2826","2826","2827","2827","2827","2827","2827","2827","2827","2827","2833","2833","2833","2833","2833","2833","2834","2834","2834","2836","2836","2836","2836","2836","2841","2841","2841","2843","2843","2843","2844","2844","2844","2844","2844","2844","2845","2846","2846","2846","2849","2849","2849","2853","2853","0508","2504","2504","2510","2510","2511","2511","2519","2519","2519","2524","2529","2529","2530","2530","2530","2530","2530","2602","2603","2605","2606","2608","2610","2611","2611","2612","2614","2614","2615","2615","2616","2617","2620","2620") ~ "Critical Minerals",
    TRUE ~ "None"
  )) %>%
  group_by(Category) %>%
  summarise(Category, CON_VAL_MO = sum(CON_VAL_MO)) %>%
  unique() %>%
  filter(Category == "None") %>%
  mutate(Category = "Canada (USMCA-compliant)")

JUNE_HS4_IMPORTS_NO_TARIFF <- JUNE_HS4_IMPORTS_NO_TARIFF %>%
  rbind(JULY_CANADA_IMPORTS) %>%
  rbind(JULY_MEXICO_IMPORTS) %>%
  filter(Category != "None") %>%
  arrange(desc(CON_VAL_MO)) %>%
  filter(CON_VAL_MO > 5000000000) %>%
  mutate(Category = factor(Category, levels = rev(c("Computers & Parts","Mexico (USMCA-compliant)","Canada (USMCA-compliant)","Pharmaceuticals","Energy","Precious Metals","Smartphones","Critical Minerals","Copper & Related","Lumber & Related","Semiconductor Equipment"))))

LARGEST_TARIFF_EXEMPTIONS <- ggplot(data = JUNE_HS4_IMPORTS_NO_TARIFF, aes(x = Category, y = CON_VAL_MO/1000000000, fill = Category == "Computers & Parts")) +
  annotate("hline", y = 0, yintercept = 0, color = "white", size = .5) +
  geom_bar(stat = "identity", position = "dodge", color = NA) +
  scale_fill_manual(values = c("TRUE" = "#EE6055", "FALSE" = "#FFE98F"), guide = "none") +
  xlab(NULL) +
  ggtitle("Largest Tariff Exemptions, July 2025") +
  ylab("US Imports in Category, July 2025") +
  scale_y_continuous(labels = scales::dollar_format(accuracy = 1, suffix = "B"), limits = c(0,40), expand = c(0,0)) +
  #labs(subtitle = "By % of US Imports") +
  labs(caption = "Graph created by @JosephPolitano using Census Data", subtitle = "Computers & Parts are Currently the Largest Category of Tariff-Exempt Products") +
  theme_apricitas + theme(legend.position = c(.5,.4), plot.margin= grid::unit(c(0.2, .2, 0.2, .2), "in"), axis.text.y = element_text(size = 16, color = "white"), axis.title.x = element_text(size = 14, color = "white")) +
  coord_flip() +
  theme(plot.title.position = "plot",plot.title = element_text(hjust = 0))

ggsave(dpi = "retina",plot = LARGEST_TARIFF_EXEMPTIONS, "Largest Tariff Exemptions Bar Chart Graph.png", type = "cairo-png", width = 9.02, height = 5.76, units = "in")
